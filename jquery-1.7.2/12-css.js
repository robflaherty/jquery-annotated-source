// **jQuery Annotated Source**.
//
// [Home](/jquery-annotated-source/) | [Previous Chapter](11-manipulation.html) | [Next Chapter](13-ajax.html)

// ## Chapter 12: CSS

(function(jQuery) {

   var ralpha = /alpha\([^)]*\)/i,
         ropacity = /opacity=([^)]*)/,
   // fixed for IE9, see #8346
         rupper = /([A-Z]|^ms)/g,
         rnum = /^[\-+]?(?:\d*\.)?\d+$/i,
         rnumnonpx = /^-?(?:\d*\.)?\d+(?!px)[^\d\s]+$/i,
         rrelNum = /^([\-+])=([\-+.\de]+)/,
         rmargin = /^margin/,

         cssShow = { position:"absolute", visibility:"hidden", display:"block" },

   // order is important!
         cssExpand = [ "Top", "Right", "Bottom", "Left" ],

         curCSS,

         getComputedStyle,
         currentStyle;

   jQuery.fn.css = function(name, value) {
      return jQuery.access(this, function(elem, name, value) {
         return value !== undefined ?
               jQuery.style(elem, name, value) :
               jQuery.css(elem, name);
      }, name, value, arguments.length > 1);
   };

   jQuery.extend({
      // Add in style property hooks for overriding the default
      // behavior of getting and setting a style property
      cssHooks: {
         opacity:{
            get:function(elem, computed) {
               if (computed) {
                  // We should always get a number back from opacity
                  var ret = curCSS(elem, "opacity");
                  return ret === "" ? "1" : ret;

               } else {
                  return elem.style.opacity;
               }
            }
         }
      },

      // Exclude the following css properties to add px
      cssNumber:{
         "fillOpacity":true,
         "fontWeight": true,
         "lineHeight": true,
         "opacity":    true,
         "orphans":    true,
         "widows":     true,
         "zIndex":     true,
         "zoom":       true
      },

      // Add in properties whose names you wish to fix before
      // setting or getting the value
      cssProps: {
         // normalize float css property
         "float":jQuery.support.cssFloat ? "cssFloat" : "styleFloat"
      },

      // Get and set the style property on a DOM Node
      style:    function(elem, name, value, extra) {
         // Don't set styles on text and comment nodes
         if (!elem || elem.nodeType === 3 || elem.nodeType === 8 || !elem.style) {
            return;
         }

         // Make sure that we're working with the right name
         var ret, type, origName = jQuery.camelCase(name),
               style = elem.style, hooks = jQuery.cssHooks[ origName ];

         name = jQuery.cssProps[ origName ] || origName;

         // Check if we're setting a value
         if (value !== undefined) {
            type = typeof value;

            // convert relative number strings (+= or -=) to relative numbers. #7345
            if (type === "string" && (ret = rrelNum.exec(value))) {
               value = ( +( ret[1] + 1) * +ret[2] ) + parseFloat(jQuery.css(elem, name));
               // Fixes bug #9237
               type = "number";
            }

            // Make sure that NaN and null values aren't set. See: #7116
            if (value == null || type === "number" && isNaN(value)) {
               return;
            }

            // If a number was passed in, add 'px' to the (except for certain CSS properties)
            if (type === "number" && !jQuery.cssNumber[ origName ]) {
               value += "px";
            }

            // If a hook was provided, use that value, otherwise just set the specified value
            if (!hooks || !("set" in hooks) || (value = hooks.set(elem, value)) !== undefined) {
               // Wrapped to prevent IE from throwing errors when 'invalid' values are provided
               // Fixes bug #5509
               try {
                  style[ name ] = value;
               } catch (e) {
               }
            }

         } else {
            // If a hook was provided get the non-computed value from there
            if (hooks && "get" in hooks && (ret = hooks.get(elem, false, extra)) !== undefined) {
               return ret;
            }

            // Otherwise just get the value from the style object
            return style[ name ];
         }
      },

      css: function(elem, name, extra) {
         var ret, hooks;

         // Make sure that we're working with the right name
         name = jQuery.camelCase(name);
         hooks = jQuery.cssHooks[ name ];
         name = jQuery.cssProps[ name ] || name;

         // cssFloat needs a special treatment
         if (name === "cssFloat") {
            name = "float";
         }

         // If a hook was provided get the computed value from there
         if (hooks && "get" in hooks && (ret = hooks.get(elem, true, extra)) !== undefined) {
            return ret;

            // Otherwise, if a way to get the computed value exists, use that
         } else if (curCSS) {
            return curCSS(elem, name);
         }
      },

      // A method for quickly swapping in/out CSS properties to get correct calculations
      swap:function(elem, options, callback) {
         var old = {},
               ret, name;

         // Remember the old values, and insert the new ones
         for (name in options) {
            old[ name ] = elem.style[ name ];
            elem.style[ name ] = options[ name ];
         }

         ret = callback.call(elem);

         // Revert the old values
         for (name in options) {
            elem.style[ name ] = old[ name ];
         }

         return ret;
      }
   });

// DEPRECATED in 1.3, Use jQuery.css() instead
   jQuery.curCSS = jQuery.css;

   if (document.defaultView && document.defaultView.getComputedStyle) {
      getComputedStyle = function(elem, name) {
         var ret, defaultView, computedStyle, width,
               style = elem.style;

         name = name.replace(rupper, "-$1").toLowerCase();

         if ((defaultView = elem.ownerDocument.defaultView) &&
               (computedStyle = defaultView.getComputedStyle(elem, null))) {

            ret = computedStyle.getPropertyValue(name);
            if (ret === "" && !jQuery.contains(elem.ownerDocument.documentElement, elem)) {
               ret = jQuery.style(elem, name);
            }
         }

         // A tribute to the "awesome hack by Dean Edwards"
         // WebKit uses "computed value (percentage if specified)" instead of "used value" for margins
         // which is against the CSSOM draft spec: http://dev.w3.org/csswg/cssom/#resolved-values
         if (!jQuery.support.pixelMargin && computedStyle && rmargin.test(name) && rnumnonpx.test(ret)) {
            width = style.width;
            style.width = ret;
            ret = computedStyle.width;
            style.width = width;
         }

         return ret;
      };
   }

   if (document.documentElement.currentStyle) {
      currentStyle = function(elem, name) {
         var left, rsLeft, uncomputed,
               ret = elem.currentStyle && elem.currentStyle[ name ],
               style = elem.style;

         // Avoid setting ret to empty string here
         // so we don't default to auto
         if (ret == null && style && (uncomputed = style[ name ])) {
            ret = uncomputed;
         }

         // From the awesome hack by Dean Edwards
         // http://erik.eae.net/archives/2007/07/27/18.54.15/#comment-102291

         // If we're not dealing with a regular pixel number
         // but a number that has a weird ending, we need to convert it to pixels
         if (rnumnonpx.test(ret)) {

            // Remember the original values
            left = style.left;
            rsLeft = elem.runtimeStyle && elem.runtimeStyle.left;

            // Put in the new values to get a computed value out
            if (rsLeft) {
               elem.runtimeStyle.left = elem.currentStyle.left;
            }
            style.left = name === "fontSize" ? "1em" : ret;
            ret = style.pixelLeft + "px";

            // Revert the changed values
            style.left = left;
            if (rsLeft) {
               elem.runtimeStyle.left = rsLeft;
            }
         }

         return ret === "" ? "auto" : ret;
      };
   }

   curCSS = getComputedStyle || currentStyle;

   function getWidthOrHeight(elem, name, extra) {

      // Start with offset property
      var val = name === "width" ? elem.offsetWidth : elem.offsetHeight,
            i = name === "width" ? 1 : 0,
            len = 4;

      if (val > 0) {
         if (extra !== "border") {
            for (; i < len; i += 2) {
               if (!extra) {
                  val -= parseFloat(jQuery.css(elem, "padding" + cssExpand[ i ])) || 0;
               }
               if (extra === "margin") {
                  val += parseFloat(jQuery.css(elem, extra + cssExpand[ i ])) || 0;
               } else {
                  val -= parseFloat(jQuery.css(elem, "border" + cssExpand[ i ] + "Width")) || 0;
               }
            }
         }

         return val + "px";
      }

      // Fall back to computed then uncomputed css if necessary
      val = curCSS(elem, name);
      if (val < 0 || val == null) {
         val = elem.style[ name ];
      }

      // Computed unit is not pixels. Stop here and return.
      if (rnumnonpx.test(val)) {
         return val;
      }

      // Normalize "", auto, and prepare for extra
      val = parseFloat(val) || 0;

      // Add padding, border, margin
      if (extra) {
         for (; i < len; i += 2) {
            val += parseFloat(jQuery.css(elem, "padding" + cssExpand[ i ])) || 0;
            if (extra !== "padding") {
               val += parseFloat(jQuery.css(elem, "border" + cssExpand[ i ] + "Width")) || 0;
            }
            if (extra === "margin") {
               val += parseFloat(jQuery.css(elem, extra + cssExpand[ i ])) || 0;
            }
         }
      }

      return val + "px";
   }

   jQuery.each([ "height", "width" ], function(i, name) {
      jQuery.cssHooks[ name ] = {
         get:function(elem, computed, extra) {
            if (computed) {
               if (elem.offsetWidth !== 0) {
                  return getWidthOrHeight(elem, name, extra);
               } else {
                  return jQuery.swap(elem, cssShow, function() {
                     return getWidthOrHeight(elem, name, extra);
                  });
               }
            }
         },

         set:function(elem, value) {
            return rnum.test(value) ?
                  value + "px" :
                  value;
         }
      };
   });

   if (!jQuery.support.opacity) {
      jQuery.cssHooks.opacity = {
         get:function(elem, computed) {
            // IE uses filters for opacity
            return ropacity.test((computed && elem.currentStyle ? elem.currentStyle.filter : elem.style.filter) || "") ?
                  ( parseFloat(RegExp.$1) / 100 ) + "" :
                  computed ? "1" : "";
         },

         set:function(elem, value) {
            var style = elem.style,
                  currentStyle = elem.currentStyle,
                  opacity = jQuery.isNumeric(value) ? "alpha(opacity=" + value * 100 + ")" : "",
                  filter = currentStyle && currentStyle.filter || style.filter || "";

            // IE has trouble with opacity if it does not have layout
            // Force it by setting the zoom level
            style.zoom = 1;

            // if setting opacity to 1, and no other filters exist - attempt to remove filter attribute #6652
            if (value >= 1 && jQuery.trim(filter.replace(ralpha, "")) === "") {

               // Setting style.filter to null, "" & " " still leave "filter:" in the cssText
               // if "filter:" is present at all, clearType is disabled, we want to avoid this
               // style.removeAttribute is IE Only, but so apparently is this code path...
               style.removeAttribute("filter");

               // if there there is no filter style applied in a css rule, we are done
               if (currentStyle && !currentStyle.filter) {
                  return;
               }
            }

            // otherwise, set new filter values
            style.filter = ralpha.test(filter) ?
                  filter.replace(ralpha, opacity) :
                  filter + " " + opacity;
         }
      };
   }

   jQuery(function() {
      // This hook cannot be added until DOM ready because the support test
      // for it is not run until after DOM ready
      if (!jQuery.support.reliableMarginRight) {
         jQuery.cssHooks.marginRight = {
            get:function(elem, computed) {
               // WebKit Bug 13343 - getComputedStyle returns wrong value for margin-right
               // Work around by temporarily setting element display to inline-block
               return jQuery.swap(elem, { "display":"inline-block" }, function() {
                  if (computed) {
                     return curCSS(elem, "margin-right");
                  } else {
                     return elem.style.marginRight;
                  }
               });
            }
         };
      }
   });

   if (jQuery.expr && jQuery.expr.filters) {
      jQuery.expr.filters.hidden = function(elem) {
         var width = elem.offsetWidth,
               height = elem.offsetHeight;

         return ( width === 0 && height === 0 ) || (!jQuery.support.reliableHiddenOffsets && ((elem.style && elem.style.display) || jQuery.css(elem, "display")) === "none");
      };

      jQuery.expr.filters.visible = function(elem) {
         return !jQuery.expr.filters.hidden(elem);
      };
   }

// These hooks are used by animate to expand properties
   jQuery.each({
      margin: "",
      padding:"",
      border: "Width"
   }, function(prefix, suffix) {

      jQuery.cssHooks[ prefix + suffix ] = {
         expand:function(value) {
            var i,

            // assumes a single number if not a string
                  parts = typeof value === "string" ? value.split(" ") : [ value ],
                  expanded = {};

            for (i = 0; i < 4; i++) {
               expanded[ prefix + cssExpand[ i ] + suffix ] =
                     parts[ i ] || parts[ i - 2 ] || parts[ 0 ];
            }

            return expanded;
         }
      };
   });

})(jQuery);
